<html>
<head>
<style>
.center
{
	width:320px;
	height:330px;
	margin:0 auto;
}
#left{
	position:relative;
	float:left;
	width:220px;
	border:1px;
	height:330px;
	border-color:blue;
	border-style:solid;
}
#right
{
	position:relative;
	float:right;
	width:90px;
	border:1px;
	height:330px;
	border-color:yellow;
	border-style:solid;
}
.element{
	position:absolute;
	width:20px;
	height:20px;
	border-color:white;
	border-style:solid;
	border-width:1px;
	background-color:blue;
}
 </style>
</head>
<body>
<div class="center">
<div id="left">
</div>
<div id="right"></div>
</div>
</body>
<script src="jquery-1.11.1.min.js"></script>
<script>
$(function(){
//代表方块的形状
var elements=[["1"],["12","15"],["156","125","256","126"],["159d","0123"],["159a","2456","126a","0124"],["0125","1456","256a","1569"],["1256"]];
var nextPositions;
var nowPositions;
var next;
var now;
var lists = new Array();
var leftEnable = true;
var rightEnable = true;
var downEnable = true;
//初始化，填充数组全部为0
function initArray()
{
	for(var x = 0 ; x < 15; x++ )
	{
		lists[x] = new Array();
		for(var y = 0 ; y < 10; y++ )
		{
			lists[x][y] = 0;
		}
	}
}
//获得下一个随机数代表的元素所在的数组位置。
function getNext()
{
	//生成随机数，范围1-18
	var random = parseInt(18*Math.random())+1;
	var sum = 0;
	var x = 0;
	var y = 0;
	//找到该随机数的位置，获得在第几个数组。
	for(var i = 0 ; i < elements.length;i++)
	{
		if(sum+elements[i].length >= random)
		{
			x = i;
			y = random - sum - 1;
			return [x,y];
		}
		sum += elements[i].length;
	}
}
//创建右侧元素
function createRight()
{
	next = getNext();
	//取出位置
	nextPositions = elements[next[0]][next[1]];
	$("#right").empty();
	for(var i = 0 ; i < nextPositions.length ; i++)
	{
		var position = parseInt(nextPositions[i],16);
		var left = (position%4)*22;
		var top = parseInt(position/4)*22;
		$("#right").append("<div class='element' style='left:"+left+";top:"+top+";'></div>")
	}
}
//创建左侧元素
function createLeft(l,t,isNew)
{
	if(isNew)
	{
		now = next;
		nowPositions = nextPositions;
		l = l +4 ;
	}
	for(var i = 0 ; i < nowPositions.length ; i++)
	{
		position = parseInt(nowPositions[i],16);
		var x = position%4;
		var y = parseInt(position/4);
		var left = (x+l)*22;
		var top = (y+t)*22;
		$("#left").append("<div class='element moving' style='left:"+left+";top:"+top+";' x='"+x+"' y='"+y+"'></div>")
	}
}
//向左移动
function left(){
	leftCheck();
	if(leftEnable)
	{
		$(".moving").each(function(){
			var left = parseInt($(this).css("left"))-22;
			$(this).css("left",left);
		})
		rightEnable = true;
	}
}
//向右移动
function right(){ 
	rightCheck();
	if(rightEnable)
	{
		$(".moving").each(function(){
			var right = parseInt($(this).css("left"))+22
			$(this).css("left",right);
		})
		leftEnable = true;
	}
}
//向下
function down(){
	downCheck();
	if(downEnable)
	{
		$(".moving").each(function(){
			var top = parseInt($(this).css("top"))+22;
			$(this).css("top",top);
		})
	}
	else
	{
		$(".moving").each(function(){
			 var x = parseInt($(this).css("left"))/22;
			 var y = (330 - parseInt($(this).css("top")))/22-1;
			 lists[y][x] = 1;
			 $(this).removeClass("moving");
			 $(this).addClass("line"+y);
		});
		lineCheck();
		createLeft(0,0,true);
		createRight();
		leftEnable = true;
		rightEnable = true;
		downEnable = true;
	}
}

function change()
{
	var moving = $(".moving");
	var left = parseInt(moving.css("left"));
	var top = parseInt(moving.css("top"));
	var x = parseInt( moving.attr("x"));
	var y = parseInt( moving.attr("y"));
	var pointLeft = left/22 - x;
	var pointTop = top/22 -y;
	if(pointLeft<0)
	{
		pointLeft = 0 ;
	}
	if(pointTop <0)
	{
		pointTop = 0;
	}
	var length = elements[now[0]].length;
	now[1] = (now[1]+1)%length;
	var p = elements[now[0]][now[1]];
	if(changeCheck(pointLeft,pointTop,p))
	{
		nowPositions = elements[now[0]][now[1]];
		$(".moving").each(function(){
			$(this).remove();
		})
		createLeft(pointLeft,pointTop,false);
		leftEnable = true;
		rightEnable = true;
	}
}
//按键
$(document).keydown(function(event){
	//向左
	if(event.which == 37)
	{
		left();
	}
	//向右
	else if(event.which == 39)
	{
		right();
	}
	//向下
	else if(event.which == 40)
	{
		down();
	}
	//空格或向上
	else if(event.which == 32|| event.which == 38)
	{
		change();
	}

})
function leftCheck(){
	$(".moving").each(function(){
			var left = parseInt($(this).css("left"));
			var x = left/22-1;
			var y =(330 - parseInt($(this).css("top")))/22-1;
			if(lists[y][x] == 1 || left == 0)
			{
				leftEnable = false;
			}
		})
}
function rightCheck()
{
	$(".moving").each(function(){
			var left = parseInt($(this).css("left"));
			var x = left/22+1;
			var y =(330 - parseInt($(this).css("top")))/22-1;
			if(lists[y][x] == 1 || left == 198)
			{
				rightEnable = false;
			}
		})
}
function downCheck()
{
	$(".moving").each(function(){
			var x = parseInt($(this).css("left"))/22;
			var y =(330 - parseInt($(this).css("top")))/22 - 2;
			if(y < 0 || lists[y][x] == 1)
			{
				downEnable = false;
			}
		})
}
function changeCheck(pointLeft,pointTop,p)
{
	for(var i = 0 ; i < p.length ; i++)
	{
		position = parseInt(p[i],16);
		var x = position%4+pointLeft;
		var y = parseInt(position/4)+pointTop;
		if(lists[y][x]==1 || x < 0 || y<0 || x >9 || y >14)
		{
			return false;
		}
	}
	return true;
}
function lineCheck()
{
	var count;
	for(var y = lists.length -1; y >= 0 ; y--)
	{
		count = 0;
		for(var x = 0; x < 10 ; x++)
		{
			if(lists[y][x] == 0)
			{
				 break;
			}
			count++;
		}
		if(count == 10)
		{
			for(var i = y ; i < lists.length -1; i++)
			{
				lists[i] = lists[i+1];
			}
			for(var i = 0 ; i<10 ; i++)
			{
				lists[14][i] =0;
			}
			var line = ".line"+y;
			$(line).each(function(){
				$(this).remove();
			})
			for(var i = y + 1 ; i < lists.length;i++)
			{
				var lineClass = ".line"+i;
				var line = "line"+i;
				var downLine = "line" +( i - 1);
				$(lineClass).each(function()
				{
					$(this).css("top",parseInt($(this).css("top"))+22);
					$(this).removeClass(line);
					$(this).addClass(downLine);
				})
			}
		}
	}
}
function start(){
	initArray();
	createRight();
	setTimeout(createLeft(0,0,true),1000);
	createRight();
	setInterval(down,1000);
}
start();
})
</script>
</body>
</html>